
@using Enjoy.Core;
@model Enjoy.Core.ViewModels.MerchantCardCouponViewModel
    <div id="page-wrapper">
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">[@Model.BrandName]卡券管理</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <div class="row">
            <div class="col-lg-12">
                @Html.HiddenFor(o => o.MerchantId);
                <!-- /.panel -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a type="button" class="btn btn-primary btn-sm" href="/cards/edit?@("merchantid="+Model.MerchantId +"&type="+CardTypes.CASH)">
                            <i class="fa fa-plus fa-fw"></i>新增券
                        </a>
                        <a type="button" class="btn btn-primary btn-sm" href="/cards/edit?@("merchantid="+Model.MerchantId +"&type="+CardTypes.MEMBER_CARD)">
                            <i class="fa fa-plus fa-fw"></i>新增卡
                        </a>
                        <div class="pull-right">
                            <div class="btn-group">
                                <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                    快速查询
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu pull-right" role="menu">
                                    <li>
                                        <a href="#"></a>
                                    </li>
                                    <li>
                                        <a href="#">已投放</a>
                                    </li>
                                    <li>
                                        <a href="#">未投放</a>
                                    </li>
                                    <li>
                                        <a href="#">已过期</a>
                                    </li>
                                    <li class="divider"></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">


                        <table id="counpon" width="100%" class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>

                                    <th>卡券编号</th>
                                    <th>所属商户</th>
                                    <th>卡券名称</th>
                                    <th>卡券类型</th>
                                    <th>创建时间</th>
                                    <th>修改时间</th>
                                    <th>库存</th>
                                    <th>状态</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.col-lg-4 (nested) -->
                    <div class="panel-footer">
                        优惠券分为折扣券、礼品券、优惠券,优惠券（现金抵扣）
                    </div>
                    <!-- /.col-lg-8 (nested) -->
                </div>
                <!-- /.row -->
            </div>
        </div>
    </div>
    @using (Html.BeginFormAntiForgeryPost(Url.Action("QueryCouponCard"))) { }
    @using (Script.Foot())
    {
        <script src="/Themes/EnjoyTheme/Content/home/js/jquery-1.11.1.min.js"></script>
        <script src="/Themes/EnjoyTheme/Content/scripts/bootstrap.min.js"></script>
        <script src="/Themes/EnjoyTheme/Content/plugins/datatables/js/jquery.dataTables.js"></script>
        <script src="/Themes/EnjoyTheme/Content/plugins/datatables-plugins/dataTables.bootstrap.min.js"></script>
        <script src="/Themes/EnjoyTheme/Content/plugins/datatables-responsive/dataTables.responsive.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                var table = $('#counpon').DataTable({
                    "paging": true,
                    "responsive": true,
                    "serverSide": true,
                    "processing": true,//加载中
                    "pagingType": "full_numbers",//分页模式
                    "language": {
                        "paginate": {
                            "first": "第一页",
                            "last": "末页",
                            "previous": "上一页",
                            "next": "下一页"
                        },
                        "emptyTable": "没有数据",
                        "info": "显示  _PAGE_ / _PAGES_ 页",
                        "infoEmpty": "显示 0 到 0 记录,共 0 记录",
                        "search": "搜索:",
                        "infoFiltered": "",
                        "lengthMenu": "每页显示 _MENU_ 条记录",
                        "processing": "玩命加载中..."
                    },
                    "ajax": {
                        "url": "/cards/QueryCouponCard",
                        "type": "POST",
                        "data": function (data) {
                            data.__RequestVerificationToken = $("input[name='__RequestVerificationToken']").val();
                            console.log(data)
                            return data;
                        }
                    },
                    "columns": [
                        { data: "WxNo" },
                        { data: "Merchant" },
                        { data: "BrandName" },
                        { data: "Type" },
                        { data: "CreatedTime" },
                        { data: "LastUpdateTime" },
                        { data: "Quantity" },
                        { data: "StateWithName" },
                        {
                            data: "Id", "render": function (data, type, row, meta) {
                                var merchantid = $("#MerchantId").val();
                                var innerHtml = "";
                                if (row.State == 1 || row.State == 32) {
                                    innerHtml = "<button id='btn_publish' class='btn btn-outline btn-primary btn-xs ' data-data='" + data + "'>提交审核</button>" +
                                        "<button id='btn_del' class='btn btn-outline btn-default btn-xs ' data-data='" + data + "'>删除</button>";
                                }
                                if (row.Status == 2) {
                                    innerHtml += "<a  class='btn btn-outline btn-success btn-xs ' href='/cards/showqr?id=" + data + "'>投放</a>";
                                }
                                innerHtml += "<a class='btn btn-outline  btn-default    btn-xs' href='/cards/edit?merchantid=" + merchantid + "&id=" + data + "&type=" + row.CardType + "'>编辑</a>";
                                return innerHtml;
                            }
                        }
                    ],
                    "columnDefs": [
                        { "searchable": true, "targets": 0 },//WxNo
                        { "searchable": false, "targets": 1 },//Merchant
                        { "searchable": true, "targets": 2 },//BrandName
                        { "searchable": true, orderable: false, "targets": 3 },//Type
                        { "searchable": true, "targets": 4 },//CreatedTime
                        { "searchable": true, "targets": 5 },//LastUpdateTime
                        { "searchable": false, orderable: false, "targets": 6 },//Quantity
                        { "searchable": true, orderable: true, "targets": 7 }//Status
                    ]
                });

                $('#counpon tbody').on('click', 'button', function () {
                    var link = "";
                    
                    if ($(this).attr("id") == "btn_del") {
                        if (confirm("真的要删除吗?") == false) {
                            return;
                        }
                        link = "/cards/delete";
                    }
                    else {//publish
                        link = "/cards/publish";                    
                    }
                    alert(link);
                    var data = table.row($(this).parents('tr')).data();
                    alert(data.Id);
                    $.ajax({
                        type: "POST",
                        url: link,
                        data: {
                            "id": data.Id,
                            "__RequestVerificationToken": $("input[name='__RequestVerificationToken']").val()
                        },
                        success: function (result) {
                            if (result.error_code == 0) {
                                table.ajax.reload();
                            }
                            else {
                                alert(result.error_message);
                            }
                        },
                        error: function (msg) {

                        },
                        complete: function (xhr, ts) {

                        }
                    });
                });
            });
        </script>
    }